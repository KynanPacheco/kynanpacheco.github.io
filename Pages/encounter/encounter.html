<!DOCTYPE html>
<head>
	<link href="/Files/template.css" type="text/css" rel="stylesheet">
	<title>Bigby's Hand Encounter Builder</title>
</head>

<body>
	<div class="banner">
		<img src="/Images/fist.png" alt="Bigby's Hand" class="fist">
	</div>
	
	<div class="body">
		<div class="left">
			<table id="activeMonster">
				<tr>
					<th id="name"></th>
					<th id="type"></th>
					<th id="size"></th>
					<th id="cr"></th>
				</tr>
				<tr>
					<td><p id="hp">Hp:-10</p><button onClick="addHealth()">+</button><button onClick="subHealth()">-</button></td>
					<td><p id="movement">Movement:</p></td>
					<td><p id="ac">AC:</p></td>
				</tr>
				<tr>
					<td><p id="misc"></p></td>
				</tr>
			</table>
			

		</div>
		
		<div class="right">
			<button onClick = "next(initiativeQueue)">Next Initiative</button>
			<table id="initiativeTracker">
				
			</table>
		</div>
		<script>
			var initiativeQueue = [];
			var initial = 0;
			var currentHP = [];
			var initiativeTracker = document.getElementById("initiativeTracker");
			
			var xhttp = new XMLHttpRequest();
			xhttp.open("GET", "/Files/monstermanual.json", false);
			xhttp.send(null);
			var monsterManual = JSON.parse(xhttp.responseText);
		
			var cookie = document.cookie;
			var monsterJSON = cookie.slice(9);
			var myMonsters = JSON.parse(monsterJSON);
			var monsterNumber = myMonsters.length;
		
			function rollInitiative(index){
				var roll = Math.floor((Math.random() * 20) + 1);
				var modifier = Math.floor((Number(monsterManual[index].dexterity) - 10) / 2);
				var initiative = roll + modifier;
				initiativeQueue.push([index, initiative]); 
			}
			
			function populateCard(index) {
				var name = document.getElementById("name").innerHTML;
				var type = document.getElementById("type").innerHTML;
				var size = document.getElementById("size").innerHTML;
				var cr = document.getElementById("cr").innerHTML;
				var movement = document.getElementById("movement").innerHTML;
				var ac = document.getElementById("ac").innerHTML;
				var resistances = document.getElementById("misc").innerHTML;
				var hp = document.getElementById("hp").innerHTML;
				
				
				var maxHP = monsterManual[index].hit_points;
				
				if(initial < monsterNumber){
					currentHP[index] = maxHP;
					initial++;
				}
				
				document.getElementById("name").innerHTML = monsterManual[index].name;
				document.getElementById("hp").innerHTML = currentHP[index];
				document.getElementById("type").innerHTML = monsterManual[index].type;
				document.getElementById("size").innerHTML = monsterManual[index].size;
				document.getElementById("cr").innerHTML ="CR " + monsterManual[index].challenge_rating;
				document.getElementById("movement").innerHTML = "Movement: " + monsterManual[index].speed;
				document.getElementById("ac").innerHTML = "AC: " + monsterManual[index].armor_class;
				document.getElementById("misc").innerHTML = "Resistances: " + monsterManual[index].damage_resistances + " Vulnerabilities: " + monsterManual[index].damage_vulnerabilities + " Damage Immunities: " + monsterManual[index].damage_immunities + " Condition Immunities: " + monsterManual[index].condition_immunities + " Senses: " + monsterManual[index].senses + " Languages: " + monsterManual[index].languages;
			}
			
			function comparator(a, b){
				if (a[1] < b[1]) return 1;
				if (a[1] > b[1]) return -1;
				return 0;
			}
			
			function next(initOrder){
				var current = initOrder.shift();
				populateCard(current[0]);
				initOrder.push(current);
			}
			
			for(var i = 0; i < monsterNumber; i++){
				rollInitiative(myMonsters[i]);
			}
			
			initiativeQueue.sort(comparator);
			
			var current = initiativeQueue.shift();
			populateCard(current[0]);
			initiativeQueue.push(current);
			
			for(i = 0; i < monsterNumber; i++){
				var row = initiativeTracker.insertRow(-1);
				var turnName = row.insertCell(-1);
				var initiativeBonus = row.insertCell(-1);
				var myTurn = row.insertCell(-1);
				
				turnName.innerHTML = "<p id='name" + i + "'>" + monsterManual[initiativeQueue[i][0]].name + "</p>";
				initiativeBonus.innerHTML = "<p id='roll" + i + "'>" + monsterManual[initiativeQueue[i][1]].name + "</p>";
				myTurn.innerHTML = "<p id='turn" + i + "'></p>";
			}
			
		</script>
		
	</div>
</body>
