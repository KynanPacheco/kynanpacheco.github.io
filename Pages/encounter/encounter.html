<!DOCTYPE html>
<head>
	<link href="/Files/template.css" type="text/css" rel="stylesheet">
	<title>Bigby's Hand Encounter Builder</title>
</head>

<body>
	<div class="banner">
		<img src="/Images/fist.png" alt="Bigby's Hand" class="fist">
	</div>
	
	<div class="body">
		<div class="left">
			<table id="activeMonster">
				<tr>
					<th id="name"></th>
					<th id="type"></th>
					<th id="size"></th>
					<th id="cr"></th>
				</tr>
				<tr>
					<td><p id="hp">Hp:-10</p><button onClick="addHealth()">+</button><button onClick="subHealth()">-</button></td>
					<td><p id="movement">Movement:</p></td>
					<td><p id="ac">AC:</p></td>
				</tr>
				<tr>
					<td><p id="misc"></p></td>
				</tr>
			</table>
			

		</div>
		
		<div class="right">
			<button onClick = "next(initiativeQueue)">Next Initiative</button>
			<table id="initiativeTracker">
				
			</table>
		</div>
		<script>
			var initiativeQueue = [];
			var initial = 0;
			var currentHP = [];
			var initiativeTracker = document.getElementById("initiativeTracker");
			var playerJSON = sessionStorage.getItem("playerInfo")
			var playerInfo = JSON.parse(playerJSON);
			var current;
			
			var xhttp = new XMLHttpRequest();
			xhttp.open("GET", "/Files/monstermanual.json", false);
			xhttp.send(null);
			var monsterManual = JSON.parse(xhttp.responseText);
		
			var cookie = document.cookie;
			var monsterJSON = cookie.slice(9);
			var myMonsters = JSON.parse(monsterJSON);
			var monsterNumber = myMonsters.length;
			
			function addHealth(){
				if (current[2] == "monster"){
					current[3]++
				}
			}
			
			function subHealth(){
				if (current[2] == "monster"){
					current[3]--
				}
			}
		
			function rollInitiative(index){
				var roll = Math.floor((Math.random() * 20) + 1);
				var modifier = Math.floor((Number(monsterManual[index].dexterity) - 10) / 2);
				var initiative = roll + modifier;
				initiativeQueue.push([index, initiative, "monster", Number(monsterManual[index].hit_points)]); 
			}
			
			function populateCard(index) {
				if(index != -1){
					var maxHP = monsterManual[index].hit_points;
				
					document.getElementById("name").innerHTML = monsterManual[index].name;
					document.getElementById("hp").innerHTML = currentHP[index];
					document.getElementById("type").innerHTML = monsterManual[index].type;
					document.getElementById("size").innerHTML = monsterManual[index].size;
					document.getElementById("cr").innerHTML ="CR " + monsterManual[index].challenge_rating;
					document.getElementById("movement").innerHTML = "Movement: " + monsterManual[index].speed;
					document.getElementById("ac").innerHTML = "AC: " + monsterManual[index].armor_class;
					document.getElementById("misc").innerHTML = "Resistances: " + monsterManual[index].damage_resistances + "<br>Vulnerabilities: " + monsterManual[index].damage_vulnerabilities + "<br>Damage Immunities: " + monsterManual[index].damage_immunities + "<br>Condition Immunities: " + monsterManual[index].condition_immunities + "<br>Senses: " + monsterManual[index].senses + "<br>Languages: " + monsterManual[index].languages;
				} else {
					document.getElementById("name").innerHTML = current[2];
					document.getElementById("type").innerHTML = "Player";
					document.getElementById("hp").innerHTML = "0";
					document.getElementById("size").innerHTML = "Unknown";
					document.getElementById("cr").innerHTML ="CR Unknown";
					document.getElementById("movement").innerHTML = "Movement: Unknown";
					document.getElementById("ac").innerHTML = "AC: Unknown";
					document.getElementById("misc").innerHTML = "Resistances: <br>Vulnerabilities: <br>Damage Immunities: <br>Condition Immunities: <br>Senses: <br>Languages: ";
				}
			}
			
			function comparator(a, b){
				if (a[1] < b[1]) return 1;
				if (a[1] > b[1]) return -1;
				return 0;
			}
			
			function next(initOrder){
				var previous = me - 1;
				if(me == initiativeQueue.length){
					me = 0;
				}
				if(me == 0){
					previous = initiativeQueue.length - 1;
					document.getElementById("turn" + me).innerHTML = "<p id='turn" + i + "'>-></p>";
					document.getElementById("turn" + previous).innerHTML = "<p id='turn" + i + "'></p>";
				} else {
					document.getElementById("turn" + me).innerHTML = "<p id='turn" + i + "'>-></p>";
					document.getElementById("turn" + previous).innerHTML = "<p id='turn" + i + "'></p>";
				}
				me++
				current = initOrder.shift();
				populateCard(current[0]);
				initOrder.push(current);
			}
			
			for(var i = 0; i < monsterNumber; i++){
				rollInitiative(myMonsters[i]);
			}
			
			for(i = 0; i < playerInfo.length; i++){
				initiativeQueue.push([-1, playerInfo[i].initiative, playerInfo[i].name ])
			}
			
			initiativeQueue.sort(comparator);
			
			for(i = 0; i < initiativeQueue.length; i++){
				var row = initiativeTracker.insertRow(-1);
				var myTurn = row.insertCell(-1);
				var turnName = row.insertCell(-1);
				var initiativeBonus = row.insertCell(-1);
				
				
				if(initiativeQueue[i][0] != -1){
					turnName.innerHTML = "<p id='name" + i + "'>" + monsterManual[initiativeQueue[i][0]].name + "</p>";
					initiativeBonus.innerHTML = "<p id='roll" + i + "'>" + initiativeQueue[i][1] + "</p>";
					myTurn.innerHTML = "<p id='turn" + i + "'></p>";
				} else{
					turnName.innerHTML = "<p id='name" + i + "'>" + initiativeQueue[i][2] + "</p>";
					initiativeBonus.innerHTML = "<p id='roll" + i + "'>" + initiativeQueue[i][1] + "</p>";
					myTurn.innerHTML = "<p id='turn" + i + "'></p>";
				}
			}
			
			document.getElementById("turn0").innerHTML = "<p id='turn0'>-></p>";
			
			var current = initiativeQueue.shift();
			populateCard(current[0]);
			initiativeQueue.push(current);
			var me = 1
			
		</script>
		
	</div>
</body>
